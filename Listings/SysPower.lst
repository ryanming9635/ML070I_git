C51 COMPILER V9.60.0.0   SYSPOWER                                                          05/11/2021 17:46:10 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE SYSPOWER
OBJECT MODULE PLACED IN .\Output\SysPower.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE SysPower.c LARGE OPTIMIZE(8,SPEED) BROWSE INCDIR(.\Include) DEBUG OBJECT
                    -EXTEND PRINT(.\Listings\SysPower.lst) TABS(2) OBJECT(.\Output\SysPower.obj)

line level    source

   1          /*****************************************************************************/
   2          /*                                                                                              */
   3          /*  TELI ML070I   MCU                                             */
   4          /*                                                                                              */
   5          /*  SysPower.c                                                                */
   6          /*                                                                                              */
   7          /*****************************************************************************/
   8          
   9          #include <math.h>
  10          #include <stdio.h>
  11          #include "Config.h"
  12          #include "reg.h"
  13          #include "typedefs.h"
  14          #include "main.h"
  15          #include "i2c.h"
  16          #include "adc.h"
  17          #include "etc_eep.h"
  18          #include "Printf.h"
  19          #include "KeyRemo.h"
  20          #include "Monitor.h"
  21          #include "CPU.h"
  22          #include "HS_DVRProtocol.h"
  23          
  24          
  25          //****************************************************************************
  26          // STRUCT / TYPE / ENUM DEFINITTIONS
  27          //****************************************************************************
  28          
  29          
  30          //****************************************************************************
  31          // CODE TABLES
  32          //****************************************************************************
  33          
  34          
  35          //****************************************************************************
  36          // VARIABLE DECLARATIONS
  37          //****************************************************************************
  38          StructPowerInfoType idata g_stPowerInfo = {0};
  39          extern StructBatteryInfoType g_stBatteryInfo;
  40          extern StructDVRInfoType g_stDVRInfo;
  41          extern BYTE PowerFlag;
  42          extern BYTE STAT1_Flag;
  43          extern BYTE STAT2_Flag;
  44          #if (_BATTERY_CHARGE_STOP==ON)
  45          extern BYTE bytBatteryStopChargeCount;
  46          extern BYTE bytBatteryStopCharge;
  47          #endif
  48          
  49          //****************************************************************************
  50          // FUNCTION DECLARATIONS
  51          //****************************************************************************
  52          void SysPowerInitial(void);
  53          void SysPowerHandler(void);
  54          void SysPowerSwitch(EnumPowerAction enumSwitch);
C51 COMPILER V9.60.0.0   SYSPOWER                                                          05/11/2021 17:46:10 PAGE 2   

  55          void UserInterfacePowerSwitch(EnumPowerAction enumSwitch);
  56          void UserInterfaceBatteryChargeMode(EnumBatteryStatus enumSwitch);
  57          
  58          extern void MCUTimerCancelTimerEvent(BYTE ucEventID);
  59          extern bit MCUTimerCheckEventValid(BYTE ucEventIndex);
  60          
  61          //****************************************************************************
  62          // FUNCTION DEFINITIONS
  63          //****************************************************************************
  64          //--------------------------------------------------
  65          // Description  : Initial Source Switch Flags
  66          // Input Value  : None
  67          // Output Value : None
  68          //--------------------------------------------------
  69          void SysPowerInitial(void)
  70          {  
  71   1        CLR_PCON3V3_P();
  72   1        CLR_Panel_EN();
  73   1        CLR_PCON5V_P();
  74   1        CLR_PCON5V();
  75   1        CLR_Panel_EN();
  76   1        CLR_PWCTRL();
  77   1        CLR_BL_PWM();
  78   1        CLR_AC_MODE();
  79   1        CLR_BAT_SYS();
  80   1        CLR_PCON_CAM();
  81   1        CLR_PCON3V3_TW();
  82   1        SET_TW8836_RST();  
  83   1        CLR_GREEN();
  84   1        CLR_RED();  
  85   1        
  86   1        MCUTimerDelayXms(200);//delay 200ms
  87   1      
  88   1        DEBUG_MESSAGE("\n\rSysPowerInitial..OK!!");   
  89   1      
  90   1      }
  91          
  92          //--------------------------------------------------
  93          // Description  : Power Handler Process
  94          // Input Value  : None
  95          // Output Value : None
  96          //--------------------------------------------------
  97          void SysPowerHandler(void)
  98          {
  99   1          // The process will deal with all kinds of power changing by power action flag.  
 100   1          switch(GET_TARGET_POWER_STATUS())
 101   1          {
 102   2              case _POWER_STATUS_NORMAL:
 103   2      
 104   2                  switch(GET_POWER_STATUS())
 105   2                  {
 106   3                      case _POWER_STATUS_OFF:
 107   3                          SysPowerSwitch(_POWER_ACTION_OFF_TO_NORMAL);
 108   3                          break;
 109   3      
 110   3                      case _POWER_STATUS_SAVING:
 111   3                          SysPowerSwitch(_POWER_ACTION_PS_TO_NORMAL);
 112   3                          break;
 113   3      
 114   3                      case _POWER_STATUS_AC_ON:
 115   3                          SysPowerSwitch(_POWER_ACTION_AC_ON_TO_NORMAL);
 116   3                          break;
C51 COMPILER V9.60.0.0   SYSPOWER                                                          05/11/2021 17:46:10 PAGE 3   

 117   3      
 118   3                      case _POWER_STATUS_NOSUPPORT_SAVING:
 119   3                          break;
 120   3                      case _POWER_STATUS_NORMAL:     
 121   3                          break;          
 122   3                      default:
 123   3                          break;
 124   3                  }            
 125   2                  
 126   2                  SET_POWER_STATUS(_POWER_STATUS_NORMAL);
 127   2                  
 128   2                  break;
 129   2                  
 130   2              case _POWER_STATUS_OFF:
 131   2      
 132   2                  switch(GET_POWER_STATUS())
 133   2                  {
 134   3                      case _POWER_STATUS_SAVING:
 135   3                          SysPowerSwitch(_POWER_ACTION_PS_TO_OFF);
 136   3                          break;
 137   3      
 138   3                      case _POWER_STATUS_AC_ON:
 139   3                          SysPowerSwitch(_POWER_ACTION_AC_ON_TO_OFF);
 140   3                          break;
 141   3      
 142   3      
 143   3                      case _POWER_STATUS_NORMAL:
 144   3                          SysPowerSwitch(_POWER_ACTION_NORMAL_TO_OFF);
 145   3                          break;
 146   3      
 147   3                      default:
 148   3                          break;
 149   3                  }
 150   2      
 151   2                  SET_POWER_STATUS(_POWER_STATUS_OFF);
 152   2                  
 153   2                  break;
 154   2      
 155   2              case _POWER_STATUS_SAVING:
 156   2      
 157   2                  switch(GET_POWER_STATUS())
 158   2                  {
 159   3                      case _POWER_STATUS_NORMAL:
 160   3                        SysPowerSwitch(_POWER_ACTION_NORMAL_TO_PS);
 161   3                          break;
 162   3      
 163   3                      default:
 164   3                          break;                   
 165   3                  }
 166   2                              
 167   2                  SET_POWER_STATUS(_POWER_STATUS_SAVING);
 168   2      
 169   2                  break;
 170   2              default:
 171   2                  break;
 172   2          }
 173   1      
 174   1          // Clear power action to avoid repeat calls in next circle.
 175   1          SET_TARGET_POWER_STATUS(GET_POWER_STATUS());
 176   1      
 177   1      }
 178          #if (_BATTERY_CHARGE_STOP==ON)
C51 COMPILER V9.60.0.0   SYSPOWER                                                          05/11/2021 17:46:10 PAGE 4   

 179          void UserInterfaceBatteryChargeMode(EnumBatteryStatus enumSwitch)
 180          {
 181   1      
 182   1        MCUTimerCancelTimerEvent(_SYSTEM_TIMER_EVENT_GRN_BLINK);
 183   1        MCUTimerCancelTimerEvent(_SYSTEM_TIMER_EVENT_GRN_2S_BLINK);
 184   1        MCUTimerCancelTimerEvent( _SYSTEM_TIMER_EVENT_RED_BLINK);
 185   1        MCUTimerCancelTimerEvent( _SYSTEM_TIMER_EVENT_GRN_RED_BLINK);
 186   1        MCUTimerCancelTimerEvent( _SYSTEM_TIMER_EVENT_GRN_ON_RED_BLINK);
 187   1        MCUTimerCancelTimerEvent( _SYSTEM_TIMER_EVENT_GRN_2S_BLINK_RED_ON);
 188   1      
 189   1        switch(enumSwitch)
 190   1        {
 191   2        case  _BATT_STATUS_STOP_CHARGE: 
 192   2              SET_PWM(_CHG_CURR,_CHARGE000mA);  
 193   2            #if (_DEBUG_MESSAGE_BatteryVoltage==ON)
                        GraphicsPrint(MAGENTA,"(1_Stop Charge)");   
                    #endif
 196   2      
 197   2            SET_BATTERY_CHARGE_STATE(_BATT_STATUS_STOP_CHARGE);
 198   2      
 199   2          if((GET_DVR_SystemReadyNotic()==_FALSE)&&(PowerFlag==ON))
 200   2            MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_BLINK);
 201   2          else if(GET_POWER_STATUS()==_POWER_STATUS_SAVING)
 202   2            {
 203   3              if(GET_AC_PLUG()==_TRUE)
 204   3              MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_2S_BLINK);//Update LED Status    
 205   3              else
 206   3                {
 207   4                  if(PowerFlag==OFF)
 208   4                  MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_RED_OFF);//Update LED Status               
 209   4                  else if(GET_BATTERY_STATE()==_BATT_STATUS_CAPACITY_LEVEL0 )
 210   4                  MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_RED_BLINK);//Update LED Status   
 211   4                  else
 212   4                  MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_2S_BLINK);//Update LED Status    
 213   4                }
 214   3            }
 215   2          else   if(GET_POWER_STATUS()==_POWER_STATUS_NORMAL)
 216   2            {
 217   3              if(GET_BATTERY_STATE()==_BATT_STATUS_CAPACITY_LEVEL0)
 218   3              MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_ON_RED_BLINK);//Update LED Status      
 219   3               else
 220   3               MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_ON_RED_OFF);//Update LED Status
 221   3            }
 222   2          else           
 223   2            MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_RED_OFF);//Update LED Status
 224   2      
 225   2                break;    
 226   2          case  _BATT_STATUS_LOW_CHARGE:
 227   2        
 228   2            if(bytBatteryStopCharge==_TRUE)
 229   2              {
 230   3              #if (_DEBUG_MESSAGE_BatteryVoltage==ON)
                      GraphicsPrint(MAGENTA,"(Low Current Charge_bytBatteryStopCharge=1)"); 
                      #endif
 233   3              SET_PWM(_CHG_CURR,_CHARGESTOP); 
 234   3      
 235   3              }
 236   2              else
 237   2              {
 238   3                SET_PWM(_CHG_CURR,_CHARGE300mA); 
 239   3            #if (_DEBUG_MESSAGE_BatteryVoltage==ON)
                        GraphicsPrint(MAGENTA,"(Low Current Charge)");  
C51 COMPILER V9.60.0.0   SYSPOWER                                                          05/11/2021 17:46:10 PAGE 5   

                    #endif
 242   3              }
 243   2              
 244   2              SET_BATTERY_CHARGE_STATE(_BATT_STATUS_LOW_CHARGE);  
 245   2              
 246   2              
 247   2            if((GET_DVR_SystemReadyNotic()==_FALSE)&&(PowerFlag==ON))
 248   2              MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_BLINK);//power on, no charging.  
 249   2            else if(GET_POWER_STATUS()==_POWER_STATUS_SAVING)
 250   2              { if((GET_AC_PLUG()==_TRUE)&&(bytBatteryStopCharge==_FALSE))
 251   3                MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_2S_BLINK_RED_ON);//Update LED Status   
 252   3                else
 253   3                MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_BLINK);//Update LED Status   
 254   3                
 255   3              }
 256   2            else
 257   2              {
 258   3                if((PowerFlag==OFF)&&(STAT1_Flag==OFF)&&(STAT2_Flag==ON)&&(bytBatteryStopCharge==_FALSE))
 259   3                MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_OFF_RED_ON);//power off, on charging.          
 260   3                else if((STAT1_Flag==OFF)&&(STAT2_Flag==ON)&&(bytBatteryStopCharge==_FALSE))
 261   3                MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_RED_ON);////power on, on charging.
 262   3                else
 263   3                  {
 264   4                MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_ON_RED_OFF);//power off, no charging.
 265   4      
 266   4                MCUTimerCancelTimerEvent(_SYSTEM_TIMER_EVENT_CHECK_BATTERY_STOP_STATE);
 267   4                MCUTimerActiveTimerEvent(SEC(5), _SYSTEM_TIMER_EVENT_CHECK_BATTERY_STOP_STATE);
 268   4      
 269   4                    #if(_DEBUG_MESSAGE_Battery_Charge_Debug==ON)
                            GraphicsPrint(GREEN,"(1BATTERY_STOP_STATE)");
                            #endif
 272   4                        /*
 273   4                        if((bytBatteryStopCharge==_FALSE)&&(Check_ADAP_IN()==_TRUE)&&((GET_BATTERY_STATE()==_BATT_STATUS_
             -CAPACITY_MAX)||(GET_BATTERY_STATE()==_BATT_STATUS_CAPACITY_MAX_STOP)))
 274   4                        {
 275   4                        bytBatteryStopCharge=_TRUE;
 276   4                        if(ReadEEP(EEP_BatteryStopCharge)==OFF)
 277   4                        WriteEEP(EEP_BatteryStopCharge,ON);
 278   4                        
 279   4                          #if(_DEBUG_MESSAGE_Battery_Charge_Debug==ON)
 280   4                            GraphicsPrint(RED,"(1bytBatteryStopCharge=1)");
 281   4                          #endif
 282   4                          SET_BATTERY_CHARGE_STATE(_BATT_STATUS_NONE);
 283   4                        }
 284   4                        */
 285   4                  }
 286   3              }
 287   2              
 288   2                break;
 289   2          case  _BATT_STATUS_HIGH_CHARGE:
 290   2            
 291   2      
 292   2            if(bytBatteryStopCharge==_TRUE)
 293   2              {
 294   3              SET_PWM(_CHG_CURR,_CHARGESTOP); 
 295   3                #if (_DEBUG_MESSAGE_BatteryVoltage==ON)
                            GraphicsPrint(MAGENTA,"(High Current Charge_bytBatteryStopCharge=1)"); 
                        #endif
 298   3      
 299   3              }
 300   2              else
 301   2              {
C51 COMPILER V9.60.0.0   SYSPOWER                                                          05/11/2021 17:46:10 PAGE 6   

 302   3                SET_PWM(_CHG_CURR,_CHARGE1000mA); 
 303   3            #if (_DEBUG_MESSAGE_BatteryVoltage==ON)
                        GraphicsPrint(MAGENTA,"(High Current Charge)"); 
                    #endif
 306   3              }   
 307   2            SET_BATTERY_CHARGE_STATE(_BATT_STATUS_HIGH_CHARGE);
 308   2      
 309   2            
 310   2            if((GET_DVR_SystemReadyNotic()==_FALSE)&&(PowerFlag==ON))
 311   2              MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_BLINK);
 312   2            else if(GET_POWER_STATUS()==_POWER_STATUS_SAVING)
 313   2              { if((GET_AC_PLUG()==_TRUE)&&(bytBatteryStopCharge==_FALSE))
 314   3                MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_RED_BLINK);//Update LED Status   
 315   3                else
 316   3                MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_BLINK);//Update LED Status     
 317   3              }
 318   2            else
 319   2              {
 320   3                if((STAT1_Flag==OFF)&&(STAT2_Flag==ON)&&(bytBatteryStopCharge==_FALSE))
 321   3                MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_OFF_RED_ON);//Update LED Status
 322   3                else
 323   3                  {
 324   4                MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_RED_OFF);//Update LED Status
 325   4      
 326   4                MCUTimerCancelTimerEvent(_SYSTEM_TIMER_EVENT_CHECK_BATTERY_STOP_STATE);
 327   4                MCUTimerActiveTimerEvent(SEC(5), _SYSTEM_TIMER_EVENT_CHECK_BATTERY_STOP_STATE);
 328   4      
 329   4                      #if(_DEBUG_MESSAGE_Battery_Charge_Debug==ON)
                              GraphicsPrint(GREEN,"(2BATTERY_STOP_STATE)");
                              #endif
 332   4      
 333   4                      /*
 334   4                      if((bytBatteryStopCharge==_FALSE)&&(Check_ADAP_IN()==_TRUE)&&((GET_BATTERY_STATE()==_BATT_STATUS_C
             -APACITY_MAX)||(GET_BATTERY_STATE()==_BATT_STATUS_CAPACITY_MAX_STOP)))
 335   4                      {
 336   4                      bytBatteryStopCharge=_TRUE;
 337   4                      if(ReadEEP(EEP_BatteryStopCharge)==OFF)
 338   4                      WriteEEP(EEP_BatteryStopCharge,ON);
 339   4                        
 340   4                      #if(_DEBUG_MESSAGE_Battery_Charge_Debug==ON)
 341   4                        GraphicsPrint(RED,"(2bytBatteryStopCharge=1)");
 342   4                      #endif
 343   4                      SET_BATTERY_CHARGE_STATE(_BATT_STATUS_NONE);
 344   4                      }
 345   4                      */
 346   4                  }   
 347   3              }
 348   2                break;
 349   2          case  _BATT_STATUS_NORMAL_CHARGE:
 350   2            
 351   2            if(bytBatteryStopCharge==_TRUE)
 352   2              {
 353   3                  SET_PWM(_CHG_CURR,_CHARGESTOP); 
 354   3            #if (_DEBUG_MESSAGE_BatteryVoltage==ON)
                        GraphicsPrint(MAGENTA,"(Normal Current Charge__bytBatteryStopCharge=1)"); 
                    #endif
 357   3              }
 358   2            else
 359   2          
 360   2              {
 361   3                SET_PWM(_CHG_CURR,_CHARGE700mA); 
 362   3            #if (_DEBUG_MESSAGE_BatteryVoltage==ON)
C51 COMPILER V9.60.0.0   SYSPOWER                                                          05/11/2021 17:46:10 PAGE 7   

                        GraphicsPrint(MAGENTA,"(Normal Current Charge)"); 
                    #endif
 365   3              }
 366   2      
 367   2            SET_BATTERY_CHARGE_STATE(_BATT_STATUS_NORMAL_CHARGE); 
 368   2            
 369   2            if((GET_DVR_SystemReadyNotic()==_FALSE)&&(PowerFlag==ON))
 370   2              MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_BLINK);
 371   2            else if(GET_POWER_STATUS()==_POWER_STATUS_SAVING)
 372   2              { 
 373   3                if((GET_AC_PLUG()==_TRUE)&&(bytBatteryStopCharge==_FALSE))
 374   3                MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_2S_BLINK_RED_ON);//Update LED Status   
 375   3                else
 376   3                MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_BLINK);//Update LED Status   
 377   3                
 378   3              }
 379   2            else
 380   2              {
 381   3                if((PowerFlag==OFF)&&(STAT1_Flag==OFF)&&(STAT2_Flag==ON)&&(bytBatteryStopCharge==_FALSE))
 382   3                MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_OFF_RED_ON);//Update LED Status          
 383   3                else if((STAT1_Flag==OFF)&&(STAT2_Flag==ON)&&(bytBatteryStopCharge==_FALSE))
 384   3                MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_RED_ON);//Update LED Status
 385   3                else
 386   3                  {
 387   4                MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_ON_RED_OFF);//Update LED Status
 388   4      
 389   4                MCUTimerCancelTimerEvent(_SYSTEM_TIMER_EVENT_CHECK_BATTERY_STOP_STATE);
 390   4                MCUTimerActiveTimerEvent(SEC(5), _SYSTEM_TIMER_EVENT_CHECK_BATTERY_STOP_STATE);
 391   4      
 392   4                        #if(_DEBUG_MESSAGE_Battery_Charge_Debug==ON)
                                GraphicsPrint(GREEN,"(3BATTERY_STOP_STATE)");
                                #endif
 395   4                        /*
 396   4                        if((bytBatteryStopCharge==_FALSE)&&(Check_ADAP_IN()==_TRUE)&&((GET_BATTERY_STATE()==_BATT_STATUS_
             -CAPACITY_MAX)||(GET_BATTERY_STATE()==_BATT_STATUS_CAPACITY_MAX_STOP)))
 397   4                        {
 398   4                        bytBatteryStopCharge=_TRUE;
 399   4                        if(ReadEEP(EEP_BatteryStopCharge)==OFF)
 400   4                        WriteEEP(EEP_BatteryStopCharge,ON);
 401   4                        
 402   4                          #if(_DEBUG_MESSAGE_Battery_Charge_Debug==ON)
 403   4                            GraphicsPrint(RED,"(3bytBatteryStopCharge=1)");
 404   4                          #endif
 405   4                          SET_BATTERY_CHARGE_STATE(_BATT_STATUS_NONE);
 406   4                        } 
 407   4                        */
 408   4                  }
 409   3              }
 410   2                break;          
 411   2          case  _BATT_STATUS_NO_BATT:
 412   2                SET_PWM(_CHG_CURR,_CHARGE060mA);
 413   2            #if (_DEBUG_MESSAGE_BatteryVoltage==ON)
                        GraphicsPrint(MAGENTA,"(1_NO BATT)");       
                    #endif
 416   2                SET_BATTERY_CHARGE_STATE(_BATT_STATUS_NO_BATT);
 417   2            
 418   2            if((GET_DVR_SystemReadyNotic()==_FALSE)&&(PowerFlag==ON))
 419   2              MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_BLINK);
 420   2            else  if(GET_POWER_STATUS()==_POWER_STATUS_NORMAL)
 421   2               MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_ON_RED_OFF);//Update LED Status
 422   2            else if(GET_POWER_STATUS()==_POWER_STATUS_SAVING)  
 423   2              MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_2S_BLINK);//Update LED Status
C51 COMPILER V9.60.0.0   SYSPOWER                                                          05/11/2021 17:46:10 PAGE 8   

 424   2            else  
 425   2              {
 426   3              MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_RED_OFF);//Update LED Status
 427   3              }
 428   2              break;
 429   2                       case _BATT_STATUS_DVR_OFF:         
 430   2              #if (_DEBUG_MESSAGE_PowerTimerEvent==ON)
                        GraphicsPrint(MAGENTA,"(DVR_POWER_OFF)"); 
                      #endif
 433   2      
 434   2                if(GET_DVR_RebootAndPower()==_TRUE)
 435   2                UserInterfacePowerSwitch(_POWER_ACTION_NORMAL_TO_OFF);
 436   2                else
 437   2                CLR_PCON5V();  
 438   2      
 439   2              MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_RED_BLINK);//Update LED Status
 440   2                   break;
 441   2      
 442   2                       case _BATT_STATUS_DVR_ON:
 443   2                  #if (_DEBUG_MESSAGE_PowerTimerEvent==ON)
                           GraphicsPrint(MAGENTA,"(DVR_POWER_ON)"); 
                          #endif
 446   2      
 447   2                    if(GET_DVR_RebootAndPower()==_TRUE)
 448   2                    {
 449   3                    UserInterfacePowerSwitch(_POWER_ACTION_OFF_TO_NORMAL);
 450   3                    CLR_DVR_RebootAndPower();
 451   3                    }
 452   2                    else
 453   2                     SET_PCON5V();  
 454   2      
 455   2                  if(GET_DVR_SystemReadyNotic()==_TRUE)
 456   2                  MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_ON_RED_OFF);//Update LED Status
 457   2                  else
 458   2                  MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_RED_BLINK);//Update LED Status
 459   2      
 460   2                  break;    
 461   2        }
 462   1      
 463   1      }
 464          #else
              void UserInterfaceBatteryChargeMode(EnumBatteryStatus enumSwitch)
              {
              
                MCUTimerCancelTimerEvent(_SYSTEM_TIMER_EVENT_GRN_BLINK);
                MCUTimerCancelTimerEvent(_SYSTEM_TIMER_EVENT_GRN_2S_BLINK);
                MCUTimerCancelTimerEvent( _SYSTEM_TIMER_EVENT_RED_BLINK);
                MCUTimerCancelTimerEvent( _SYSTEM_TIMER_EVENT_GRN_RED_BLINK);
                MCUTimerCancelTimerEvent( _SYSTEM_TIMER_EVENT_GRN_ON_RED_BLINK);
                MCUTimerCancelTimerEvent( _SYSTEM_TIMER_EVENT_GRN_2S_BLINK_RED_ON);
              
                switch(enumSwitch)
                {
                case  _BATT_STATUS_STOP_CHARGE: 
                      SET_PWM(_CHG_CURR,_CHARGE000mA);  
                    #if (_DEBUG_MESSAGE_BatteryVoltage==ON)
                        GraphicsPrint(MAGENTA,"(1_Stop Charge)");   
                    #endif
              
                    SET_BATTERY_CHARGE_STATE(_BATT_STATUS_STOP_CHARGE);
              
                  if((GET_DVR_SystemReadyNotic()==_FALSE)&&(PowerFlag==ON))
C51 COMPILER V9.60.0.0   SYSPOWER                                                          05/11/2021 17:46:10 PAGE 9   

                    MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_BLINK);
                  else if(GET_POWER_STATUS()==_POWER_STATUS_SAVING)
                    {
                      if(GET_AC_PLUG()==_TRUE)
                      MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_2S_BLINK);//Update LED Status    
                      else
                        {
                          if(PowerFlag==OFF)
                          MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_RED_OFF);//Update LED Status               
                          else if(GET_BATTERY_STATE()==_BATT_STATUS_CAPACITY_LEVEL0 )
                          MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_RED_BLINK);//Update LED Status   
                          else
                          MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_2S_BLINK);//Update LED Status    
                        }
                    }
                  else   if(GET_POWER_STATUS()==_POWER_STATUS_NORMAL)
                    {
                      if(GET_BATTERY_STATE()==_BATT_STATUS_CAPACITY_LEVEL0)
                      MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_ON_RED_BLINK);//Update LED Status      
                       else
                       MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_ON_RED_OFF);//Update LED Status
                    }
                  else           
                    MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_RED_OFF);//Update LED Status
              
                        break;    
                  case  _BATT_STATUS_LOW_CHARGE:
                        SET_PWM(_CHG_CURR,_CHARGE300mA); 
                    #if (_DEBUG_MESSAGE_BatteryVoltage==ON)
                        GraphicsPrint(MAGENTA,"(Low Current Charge)");  
                    #endif
                        SET_BATTERY_CHARGE_STATE(_BATT_STATUS_LOW_CHARGE);  
                    
                    if((GET_DVR_SystemReadyNotic()==_FALSE)&&(PowerFlag==ON))
                      MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_BLINK);
                    else if(GET_POWER_STATUS()==_POWER_STATUS_SAVING)
                      { if(GET_AC_PLUG()==_TRUE)
                        MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_2S_BLINK_RED_ON);//Update LED Status   
                        else
                        MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_BLINK);//Update LED Status   
                        
                      }
                    else
                      {
                        if((PowerFlag==OFF)&&(STAT1_Flag==OFF)&&(STAT2_Flag==ON))
                        MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_OFF_RED_ON);//Update LED Status          
                        else if((STAT1_Flag==OFF)&&(STAT2_Flag==ON))
                        MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_RED_ON);//Update LED Status
                        else
                        MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_ON_RED_OFF);//Update LED Status
                          
                      }
                        break;
                  case  _BATT_STATUS_HIGH_CHARGE:
                        SET_PWM(_CHG_CURR,_CHARGE1000mA); 
                    #if (_DEBUG_MESSAGE_BatteryVoltage==ON)
                        GraphicsPrint(MAGENTA,"(High Current Charge)"); 
                    #endif
                  
                    SET_BATTERY_CHARGE_STATE(_BATT_STATUS_HIGH_CHARGE);
              
                    
C51 COMPILER V9.60.0.0   SYSPOWER                                                          05/11/2021 17:46:10 PAGE 10  

                    if((GET_DVR_SystemReadyNotic()==_FALSE)&&(PowerFlag==ON))
                      MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_BLINK);
                    else if(GET_POWER_STATUS()==_POWER_STATUS_SAVING)
                      { if(GET_AC_PLUG()==_TRUE)
                        MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_RED_BLINK);//Update LED Status   
                        else
                        MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_BLINK);//Update LED Status     
                      }
                    else
                      {
                        if((STAT1_Flag==OFF)&&(STAT2_Flag==ON))
                        MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_OFF_RED_ON);//Update LED Status
                        else
                        MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_RED_OFF);//Update LED Status
                              
                      }
                        break;
                  case  _BATT_STATUS_NORMAL_CHARGE:
                        SET_PWM(_CHG_CURR,_CHARGE700mA); 
                    #if (_DEBUG_MESSAGE_BatteryVoltage==ON)
                        GraphicsPrint(MAGENTA,"(Normal Current Charge)"); 
                    #endif
                        SET_BATTERY_CHARGE_STATE(_BATT_STATUS_NORMAL_CHARGE); 
                    
                    if((GET_DVR_SystemReadyNotic()==_FALSE)&&(PowerFlag==ON))
                      MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_BLINK);
                    else if(GET_POWER_STATUS()==_POWER_STATUS_SAVING)
                      { 
                        if(GET_AC_PLUG()==_TRUE)
                        MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_2S_BLINK_RED_ON);//Update LED Status   
                        else
                        MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_BLINK);//Update LED Status   
                        
                      }
                    else
                      {
                        if((PowerFlag==OFF)&&(STAT1_Flag==OFF)&&(STAT2_Flag==ON))
                        MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_OFF_RED_ON);//Update LED Status          
                        else if((STAT1_Flag==OFF)&&(STAT2_Flag==ON))
                        MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_RED_ON);//Update LED Status
                        else
                        MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_ON_RED_OFF);//Update LED Status
                          
                      }
                        break;          
                  case  _BATT_STATUS_NO_BATT:
                        SET_PWM(_CHG_CURR,_CHARGE060mA);
                    #if (_DEBUG_MESSAGE_BatteryVoltage==ON)
                        GraphicsPrint(MAGENTA,"(1_NO BATT)");       
                    #endif
                        SET_BATTERY_CHARGE_STATE(_BATT_STATUS_NO_BATT);
                    
                    if((GET_DVR_SystemReadyNotic()==_FALSE)&&(PowerFlag==ON))
                      MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_BLINK);
                    else  if(GET_POWER_STATUS()==_POWER_STATUS_NORMAL)
                       MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_ON_RED_OFF);//Update LED Status
                    else if(GET_POWER_STATUS()==_POWER_STATUS_SAVING)  
                      MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_2S_BLINK);//Update LED Status
                    else  
                      {
                      MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_RED_OFF);//Update LED Status
                      }
C51 COMPILER V9.60.0.0   SYSPOWER                                                          05/11/2021 17:46:10 PAGE 11  

                    break;
                               case _BATT_STATUS_DVR_OFF:         
                      #if (_DEBUG_MESSAGE_PowerTimerEvent==ON)
                        GraphicsPrint(MAGENTA,"(DVR_POWER_OFF)"); 
                      #endif
              
                        if(GET_DVR_RebootAndPower()==_TRUE)
                        UserInterfacePowerSwitch(_POWER_ACTION_NORMAL_TO_OFF);
                        else
                        CLR_PCON5V();  
              
                      MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_RED_BLINK);//Update LED Status
                           break;
              
                               case _BATT_STATUS_DVR_ON:
                          #if (_DEBUG_MESSAGE_PowerTimerEvent==ON)
                           GraphicsPrint(MAGENTA,"(DVR_POWER_ON)"); 
                          #endif
              
                            if(GET_DVR_RebootAndPower()==_TRUE)
                            {
                            UserInterfacePowerSwitch(_POWER_ACTION_OFF_TO_NORMAL);
                            CLR_DVR_RebootAndPower();
                            }
                            else
                             SET_PCON5V();  
              
                          if(GET_DVR_SystemReadyNotic()==_TRUE)
                          MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_ON_RED_OFF);//Update LED Status
                          else
                          MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_RED_BLINK);//Update LED Status
              
                          break;    
                }
              
              }
              
              #endif
 648          void UserInterfacePowerSwitch(EnumPowerAction enumSwitch)
 649          {
 650   1        Printf("\r\n(PowerSwitch=%02x)",(WORD)enumSwitch);  
 651   1      
 652   1        
 653   1          switch(enumSwitch)
 654   1          {
 655   2              case _POWER_ACTION_AC_ON_TO_NORMAL:
 656   2        case _POWER_ACTION_PS_TO_NORMAL:
 657   2        case _POWER_ACTION_OFF_TO_NORMAL:
 658   2      #if 1     
 659   2        
 660   2            SET_PCON5V();   
 661   2            SET_PWCTRL();
 662   2            SET_AC_MODE();
 663   2            SET_BAT_SYS();
 664   2            SET_PCON_CAM();
 665   2            SET_PCON3V3_TW();
 666   2            MCUTimerDelayXms(20);//delay 20ms Power-On Sequence of Panel    
 667   2            CLR_TW8836_RST();
 668   2            
 669   2        MCUTimerActiveTimerEvent(SEC(0.5), _SYSTEM_TIMER_EVENT_JUDGE_FIRST_GET_BATT_BTH_STATE);
 670   2        MCUTimerActiveTimerEvent(SEC(/*0.5*/1), _USER_TIMER_EVENT_PANEL_BACKLIGHT_ON);  
 671   2      
C51 COMPILER V9.60.0.0   SYSPOWER                                                          05/11/2021 17:46:10 PAGE 12  

 672   2      #else
                    SET_PCON3V3_P();
                    SET_Panel_EN();
                    SET_PCON5V_P();
                    SET_PCON5V();   
                    SET_PWCTRL();
                    SET_BL_PWM();
                    SET_AC_MODE();
                    SET_BAT_SYS();
                    SET_PCON_CAM();
                    SET_PCON3V3_TW();
                    MCUTimerDelayXms(64);//delay 64ms Power-On Sequence and Reset
                    CLR_TW8836_RST();  
              #endif
 686   2                  break;
 687   2          case  _POWER_ACTION_PANEL_POWER_ON:
 688   2            SET_PCON3V3_P();
 689   2            SET_Panel_EN();
 690   2            MCUTimerDelayXms(64);//delay 64ms Power-On Sequence and Reset
 691   2            SET_PCON5V_P();
 692   2            SET_BL_PWM();
 693   2      
 694   2            if(GET_DVR_EntrySleepMode()==_TRUE)
 695   2            {
 696   3            CLR_DVR_EntrySleepMode();
 697   3            MCU_SendCmdToDVR(MCU_PROTOCOL_CMD_SLEEP_WAKE_UP);
 698   3            }
 699   2      
 700   2            P3M1=0x00|0x30;//p3.4 and P3.5 set push pull mode ryan@20210223
 701   2            break;
 702   2      
 703   2              case _POWER_ACTION_AC_ON_TO_OFF:
 704   2        case _POWER_ACTION_NORMAL_TO_OFF:
 705   2        case _POWER_ACTION_PS_TO_OFF:
 706   2      
 707   2          SET_TW8836_RST(); 
 708   2          CLR_PCON3V3_P();
 709   2          CLR_PCON5V_P();
 710   2          CLR_Panel_EN();
 711   2          CLR_PCON5V();
 712   2          CLR_Panel_EN();
 713   2          CLR_PWCTRL();
 714   2          CLR_AC_MODE();
 715   2          CLR_BAT_SYS();
 716   2          CLR_PCON_CAM();
 717   2          //#if (_DEBUG_MESSAGE_Monitor==ON)
 718   2          //#else
 719   2          //CLR_PCON3V3_TW(); ///關閉debug message UART1 有問題
 720   2          //#endif
 721   2          CLR_BL_PWM();
 722   2      
 723   2          #if 0// (_DEBUG_MESSAGE_Monitor==ON)
                  #else
 725   2          CLR_PCON3V3_TW(); ///關閉debug message UART1 有問題
 726   2          #endif
 727   2      
 728   2          SET_DVR_PowerOFFDelay();
 729   2          MCUTimerActiveTimerEvent( SEC(3),_SYSTEM_TIMER_EVENT_POWER_OFF_ON_DELAY);
 730   2                  break;
 731   2      
 732   2              case _POWER_ACTION_NORMAL_TO_PS:
 733   2      
C51 COMPILER V9.60.0.0   SYSPOWER                                                          05/11/2021 17:46:10 PAGE 13  

 734   2            //CLR_PCON3V3_P();
 735   2            //CLR_PCON5V_P();
 736   2            CLR_Panel_EN();
 737   2            CLR_PCON5V_P();
 738   2            CLR_PWCTRL();
 739   2            CLR_AC_MODE();
 740   2            //CLR_BAT_SYS();
 741   2            CLR_PCON_CAM();
 742   2            CLR_BL_PWM();
 743   2            //CLR_PCON5V();
 744   2            //SET_TW8836_RST(); 
 745   2            //CLR_PCON3V3_TW();
 746   2            
 747   2            P3M1=0x00;//p3.4 and P3.5 set output ryan@20210226
 748   2                  break;
 749   2      
 750   2              default:
 751   2      
 752   2                  break;
 753   2          }
 754   1      
 755   1          
 756   1      SET_BATTERY_CHARGE_STATE(_BATT_STATUS_NONE);//reset battery state.
 757   1      
 758   1      }
 759          
 760          //--------------------------------------------------
 761          // Description  : Deal With Power Manage According To Input Pamater
 762          // Input Value  : ucSwitch    --> Power action description.
 763          // Output Value : None
 764          //--------------------------------------------------
 765          void SysPowerSwitch(EnumPowerAction enumSwitch)
 766          {
 767   1      
 768   1      
 769   1          switch(enumSwitch)
 770   1          {
 771   2              case _POWER_ACTION_NORMAL_TO_PS:
 772   2            UserInterfacePowerSwitch(enumSwitch); 
 773   2                  break;
 774   2      
 775   2              case _POWER_ACTION_NORMAL_TO_OFF:
 776   2              case _POWER_ACTION_AC_ON_TO_OFF:
 777   2        case _POWER_ACTION_DVR_POWER_OFF: 
 778   2            case _POWER_ACTION_PS_TO_OFF:
 779   2          UserInterfacePowerSwitch(enumSwitch); 
 780   2        break;
 781   2                  
 782   2      //       case _POWER_ACTION_PS_TO_OFF:
 783   2      //            break;
 784   2      
 785   2              case _POWER_ACTION_AC_ON_TO_NORMAL:
 786   2              case _POWER_ACTION_OFF_TO_NORMAL:
 787   2              case _POWER_ACTION_PS_TO_NORMAL:    
 788   2               case _POWER_ACTION_PS_TO_BATT: 
 789   2        case _POWER_ACTION_DVR_POWER_ON:
 790   2        case  _POWER_ACTION_PANEL_POWER_ON:
 791   2          // User Power Process
 792   2                      UserInterfacePowerSwitch(enumSwitch);        
 793   2                break;
 794   2            
 795   2              default:
C51 COMPILER V9.60.0.0   SYSPOWER                                                          05/11/2021 17:46:10 PAGE 14  

 796   2                  break;
 797   2          }
 798   1        
 799   1      }
 800          
 801          
 802          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1216    ----
   CONSTANT SIZE    =     45    ----
   XDATA SIZE       =   ----       3
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =      2    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)

C51 COMPILER V9.60.0.0   SYSPOWER                                                          08/24/2021 10:37:20 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE SYSPOWER
OBJECT MODULE PLACED IN .\Output\SysPower.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE SysPower.c LARGE OPTIMIZE(8,SPEED) BROWSE INCDIR(.\Include) DEBUG OBJECT
                    -EXTEND PRINT(.\Listings\SysPower.lst) TABS(2) OBJECT(.\Output\SysPower.obj)

line level    source

   1          /*****************************************************************************/
   2          /*                                                                                              */
   3          /*  TELI ML070I   MCU                                             */
   4          /*                                                                                              */
   5          /*  SysPower.c                                                                */
   6          /*                                                                                              */
   7          /*****************************************************************************/
   8          
   9          #include <math.h>
  10          #include <stdio.h>
  11          #include "Config.h"
  12          #include "reg.h"
  13          #include "typedefs.h"
  14          #include "main.h"
  15          #include "i2c.h"
  16          #include "adc.h"
  17          #include "etc_eep.h"
  18          #include "Printf.h"
  19          #include "KeyRemo.h"
  20          #include "Monitor.h"
  21          #include "CPU.h"
  22          #include "HS_DVRProtocol.h"
  23          
  24          
  25          //****************************************************************************
  26          // STRUCT / TYPE / ENUM DEFINITTIONS
  27          //****************************************************************************
  28          
  29          
  30          //****************************************************************************
  31          // CODE TABLES
  32          //****************************************************************************
  33          
  34          
  35          //****************************************************************************
  36          // VARIABLE DECLARATIONS
  37          //****************************************************************************
  38          StructPowerInfoType idata g_stPowerInfo = {0};
  39          extern StructBatteryInfoType g_stBatteryInfo;
  40          extern StructDVRInfoType g_stDVRInfo;
  41          extern BYTE PowerFlag;
  42          extern BYTE STAT1_Flag;
  43          extern BYTE STAT2_Flag;
  44          #if (_BATTERY_CHARGE_STOP==ON)
  45          extern BYTE bytBatteryStopChargeCount;
  46          extern BYTE bytBatteryStopCharge;
  47          #endif
  48          
  49          #if (_BATTERY_CHECK_WITH_NO_CHARGE==ON)
  50          extern BYTE bytBatteryVoltageCheck;
  51          #endif
  52          
  53          //****************************************************************************
  54          // FUNCTION DECLARATIONS
C51 COMPILER V9.60.0.0   SYSPOWER                                                          08/24/2021 10:37:20 PAGE 2   

  55          //****************************************************************************
  56          void SysPowerInitial(void);
  57          void SysPowerHandler(void);
  58          void SysPowerSwitch(EnumPowerAction enumSwitch);
  59          void UserInterfacePowerSwitch(EnumPowerAction enumSwitch);
  60          void UserInterfaceBatteryChargeMode(EnumBatteryStatus enumSwitch);
  61          
  62          extern void MCUTimerCancelTimerEvent(BYTE ucEventID);
  63          extern bit MCUTimerCheckEventValid(BYTE ucEventIndex);
  64          
  65          //****************************************************************************
  66          // FUNCTION DEFINITIONS
  67          //****************************************************************************
  68          //--------------------------------------------------
  69          // Description  : Initial Source Switch Flags
  70          // Input Value  : None
  71          // Output Value : None
  72          //--------------------------------------------------
  73          void SysPowerInitial(void)
  74          {  
  75   1        CLR_PCON3V3_P();
  76   1        CLR_Panel_EN();
  77   1        CLR_PCON5V_P();
  78   1        CLR_PCON5V();
  79   1        CLR_Panel_EN();
  80   1        CLR_PWCTRL();
  81   1        CLR_BL_PWM();
  82   1        CLR_AC_MODE();
  83   1        CLR_BAT_SYS();
  84   1        CLR_PCON_CAM();
  85   1        CLR_PCON3V3_TW();
  86   1        SET_TW8836_RST();  
  87   1        CLR_GREEN();
  88   1        CLR_RED();  
  89   1        
  90   1        MCUTimerDelayXms(200);//delay 200ms
  91   1      
  92   1        DEBUG_MESSAGE("\n\rSysPowerInitial..OK!!");   
  93   1      
  94   1      }
  95          
  96          //--------------------------------------------------
  97          // Description  : Power Handler Process
  98          // Input Value  : None
  99          // Output Value : None
 100          //--------------------------------------------------
 101          void SysPowerHandler(void)
 102          {
 103   1          // The process will deal with all kinds of power changing by power action flag.  
 104   1          switch(GET_TARGET_POWER_STATUS())
 105   1          {
 106   2              case _POWER_STATUS_NORMAL:
 107   2      
 108   2                  switch(GET_POWER_STATUS())
 109   2                  {
 110   3                      case _POWER_STATUS_OFF:
 111   3                          SysPowerSwitch(_POWER_ACTION_OFF_TO_NORMAL);
 112   3                          break;
 113   3      
 114   3                      case _POWER_STATUS_SAVING:
 115   3                          SysPowerSwitch(_POWER_ACTION_PS_TO_NORMAL);
 116   3                          break;
C51 COMPILER V9.60.0.0   SYSPOWER                                                          08/24/2021 10:37:20 PAGE 3   

 117   3      
 118   3                      case _POWER_STATUS_AC_ON:
 119   3                          SysPowerSwitch(_POWER_ACTION_AC_ON_TO_NORMAL);
 120   3                          break;
 121   3      
 122   3                      case _POWER_STATUS_NOSUPPORT_SAVING:
 123   3                          break;
 124   3                      case _POWER_STATUS_NORMAL:     
 125   3                          break;          
 126   3                      default:
 127   3                          break;
 128   3                  }            
 129   2                  
 130   2                  SET_POWER_STATUS(_POWER_STATUS_NORMAL);
 131   2                  
 132   2                  break;
 133   2                  
 134   2              case _POWER_STATUS_OFF:
 135   2      
 136   2                  switch(GET_POWER_STATUS())
 137   2                  {
 138   3                      case _POWER_STATUS_SAVING:
 139   3                          SysPowerSwitch(_POWER_ACTION_PS_TO_OFF);
 140   3                          break;
 141   3      
 142   3                      case _POWER_STATUS_AC_ON:
 143   3                          SysPowerSwitch(_POWER_ACTION_AC_ON_TO_OFF);
 144   3                          break;
 145   3      
 146   3      
 147   3                      case _POWER_STATUS_NORMAL:
 148   3                          SysPowerSwitch(_POWER_ACTION_NORMAL_TO_OFF);
 149   3                          break;
 150   3      
 151   3                      default:
 152   3                          break;
 153   3                  }
 154   2      
 155   2                  SET_POWER_STATUS(_POWER_STATUS_OFF);
 156   2                  
 157   2                  break;
 158   2      
 159   2              case _POWER_STATUS_SAVING:
 160   2      
 161   2                  switch(GET_POWER_STATUS())
 162   2                  {
 163   3                      case _POWER_STATUS_NORMAL:
 164   3                        SysPowerSwitch(_POWER_ACTION_NORMAL_TO_PS);
 165   3                          break;
 166   3      
 167   3                      default:
 168   3                          break;                   
 169   3                  }
 170   2                              
 171   2                  SET_POWER_STATUS(_POWER_STATUS_SAVING);
 172   2      
 173   2                  break;
 174   2              default:
 175   2                  break;
 176   2          }
 177   1      
 178   1          // Clear power action to avoid repeat calls in next circle.
C51 COMPILER V9.60.0.0   SYSPOWER                                                          08/24/2021 10:37:20 PAGE 4   

 179   1          SET_TARGET_POWER_STATUS(GET_POWER_STATUS());
 180   1      
 181   1      }
 182          #if (_BATTERY_CHARGE_STOP==ON)
 183          void UserInterfaceBatteryChargeMode(EnumBatteryStatus enumSwitch)
 184          {
 185   1      
 186   1        MCUTimerCancelTimerEvent(_SYSTEM_TIMER_EVENT_GRN_BLINK);
 187   1        MCUTimerCancelTimerEvent(_SYSTEM_TIMER_EVENT_GRN_2S_BLINK);
 188   1        MCUTimerCancelTimerEvent( _SYSTEM_TIMER_EVENT_RED_BLINK);
 189   1        MCUTimerCancelTimerEvent( _SYSTEM_TIMER_EVENT_GRN_RED_BLINK);
 190   1        MCUTimerCancelTimerEvent( _SYSTEM_TIMER_EVENT_GRN_ON_RED_BLINK);
 191   1        MCUTimerCancelTimerEvent( _SYSTEM_TIMER_EVENT_GRN_2S_BLINK_RED_ON);
 192   1      
 193   1        switch(enumSwitch)
 194   1        {
 195   2        case  _BATT_STATUS_STOP_CHARGE: 
 196   2              SET_PWM(_CHG_CURR,_CHARGE000mA);  
 197   2            #if (_DEBUG_MESSAGE_BatteryVoltage==ON)
                        GraphicsPrint(MAGENTA,"(1_Stop Charge)");   
                    #endif
 200   2      
 201   2            SET_BATTERY_CHARGE_STATE(_BATT_STATUS_STOP_CHARGE);
 202   2      
 203   2          if((GET_DVR_SystemReadyNotic()==_FALSE)&&(PowerFlag==ON))
 204   2            MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_BLINK);
 205   2          else if(GET_POWER_STATUS()==_POWER_STATUS_SAVING)
 206   2            {
 207   3              if(GET_AC_PLUG()==_TRUE)
 208   3              MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_2S_BLINK);//Update LED Status    
 209   3              else
 210   3                {
 211   4                  if(PowerFlag==OFF)
 212   4                  MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_RED_OFF);//Update LED Status               
 213   4                  else if(GET_BATTERY_STATE()==_BATT_STATUS_CAPACITY_LEVEL0 )
 214   4                  MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_RED_BLINK);//Update LED Status   
 215   4                  else
 216   4                  MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_2S_BLINK);//Update LED Status    
 217   4                }
 218   3            }
 219   2          else   if(GET_POWER_STATUS()==_POWER_STATUS_NORMAL)
 220   2            {
 221   3              if(GET_BATTERY_STATE()==_BATT_STATUS_CAPACITY_LEVEL0)
 222   3              MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_ON_RED_BLINK);//Update LED Status      
 223   3               else
 224   3               MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_ON_RED_OFF);//Update LED Status
 225   3            }
 226   2          else           
 227   2            MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_RED_OFF);//Update LED Status
 228   2      
 229   2                break;    
 230   2          case  _BATT_STATUS_LOW_CHARGE:
 231   2        
 232   2            if(bytBatteryStopCharge==_TRUE)
 233   2              {
 234   3              #if (_DEBUG_MESSAGE_BatteryVoltage==ON)
                      GraphicsPrint(MAGENTA,"(Low Current Charge_bytBatteryStopCharge=1)"); 
                      #endif
 237   3              SET_PWM(_CHG_CURR,_CHARGESTOP); 
 238   3      
 239   3              }
 240   2              else
C51 COMPILER V9.60.0.0   SYSPOWER                                                          08/24/2021 10:37:20 PAGE 5   

 241   2              {
 242   3                SET_PWM(_CHG_CURR,_CHARGE300mA); 
 243   3            #if (_DEBUG_MESSAGE_BatteryVoltage==ON)
                        GraphicsPrint(MAGENTA,"(Low Current Charge)");  
                    #endif
 246   3              }
 247   2              
 248   2              SET_BATTERY_CHARGE_STATE(_BATT_STATUS_LOW_CHARGE);  
 249   2              
 250   2              
 251   2            if((GET_DVR_SystemReadyNotic()==_FALSE)&&(PowerFlag==ON))
 252   2              MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_BLINK);//power on, no charging.  
 253   2            else if(GET_POWER_STATUS()==_POWER_STATUS_SAVING)
 254   2              { if((GET_AC_PLUG()==_TRUE)&&(bytBatteryStopCharge==_FALSE))
 255   3                MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_2S_BLINK_RED_ON);//Update LED Status   
 256   3                else
 257   3                MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_2S_BLINK);//Update LED Status    
 258   3                
 259   3              }
 260   2            else
 261   2              {
 262   3                if((PowerFlag==OFF)&&(STAT1_Flag==OFF)&&(STAT2_Flag==ON)&&(bytBatteryStopCharge==_FALSE))
 263   3                MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_OFF_RED_ON);//power off, on charging.          
 264   3                else if((STAT1_Flag==OFF)&&(STAT2_Flag==ON)&&(bytBatteryStopCharge==_FALSE))
 265   3                MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_RED_ON);////power on, on charging.
 266   3                else
 267   3                  {
 268   4                MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_ON_RED_OFF);//power off, no charging.
 269   4      
 270   4                MCUTimerCancelTimerEvent(_SYSTEM_TIMER_EVENT_CHECK_BATTERY_STOP_STATE);
 271   4                MCUTimerActiveTimerEvent(SEC(5), _SYSTEM_TIMER_EVENT_CHECK_BATTERY_STOP_STATE);
 272   4      
 273   4                    #if(_DEBUG_MESSAGE_Battery_Charge_Debug==ON)
                            GraphicsPrint(GREEN,"(1BATTERY_STOP_STATE)");
                            #endif
 276   4                        /*
 277   4                        if((bytBatteryStopCharge==_FALSE)&&(Check_ADAP_IN()==_TRUE)&&((GET_BATTERY_STATE()==_BATT_STATUS_
             -CAPACITY_MAX)||(GET_BATTERY_STATE()==_BATT_STATUS_CAPACITY_MAX_STOP)))
 278   4                        {
 279   4                        bytBatteryStopCharge=_TRUE;
 280   4                        if(ReadEEP(EEP_BatteryStopCharge)==OFF)
 281   4                        WriteEEP(EEP_BatteryStopCharge,ON);
 282   4                        
 283   4                          #if(_DEBUG_MESSAGE_Battery_Charge_Debug==ON)
 284   4                            GraphicsPrint(RED,"(1bytBatteryStopCharge=1)");
 285   4                          #endif
 286   4                          SET_BATTERY_CHARGE_STATE(_BATT_STATUS_NONE);
 287   4                        }
 288   4                        */
 289   4                  }
 290   3              }
 291   2              
 292   2                break;
 293   2          case  _BATT_STATUS_HIGH_CHARGE:
 294   2            
 295   2      
 296   2            if(bytBatteryStopCharge==_TRUE)
 297   2              {
 298   3              SET_PWM(_CHG_CURR,_CHARGESTOP); 
 299   3                #if (_DEBUG_MESSAGE_BatteryVoltage==ON)
                            GraphicsPrint(MAGENTA,"(High Current Charge_bytBatteryStopCharge=1)"); 
                        #endif
C51 COMPILER V9.60.0.0   SYSPOWER                                                          08/24/2021 10:37:20 PAGE 6   

 302   3      
 303   3              }
 304   2              else
 305   2              {
 306   3                SET_PWM(_CHG_CURR,_CHARGE1000mA); 
 307   3            #if (_DEBUG_MESSAGE_BatteryVoltage==ON)
                        GraphicsPrint(MAGENTA,"(High Current Charge)"); 
                    #endif
 310   3              }   
 311   2            SET_BATTERY_CHARGE_STATE(_BATT_STATUS_HIGH_CHARGE);
 312   2      
 313   2            
 314   2            if((GET_DVR_SystemReadyNotic()==_FALSE)&&(PowerFlag==ON))
 315   2              MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_BLINK);
 316   2            else if(GET_POWER_STATUS()==_POWER_STATUS_SAVING)
 317   2              { if((GET_AC_PLUG()==_TRUE)&&(bytBatteryStopCharge==_FALSE))
 318   3                MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_RED_BLINK);//Update LED Status   
 319   3                else
 320   3                MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_2S_BLINK);//Update LED Status      
 321   3              }
 322   2            else
 323   2              {
 324   3                if((STAT1_Flag==OFF)&&(STAT2_Flag==ON)&&(bytBatteryStopCharge==_FALSE))
 325   3                MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_OFF_RED_ON);//Update LED Status
 326   3                else
 327   3                  {
 328   4                MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_RED_OFF);//Update LED Status
 329   4      
 330   4                MCUTimerCancelTimerEvent(_SYSTEM_TIMER_EVENT_CHECK_BATTERY_STOP_STATE);
 331   4                MCUTimerActiveTimerEvent(SEC(5), _SYSTEM_TIMER_EVENT_CHECK_BATTERY_STOP_STATE);
 332   4      
 333   4                      #if(_DEBUG_MESSAGE_Battery_Charge_Debug==ON)
                              GraphicsPrint(GREEN,"(2BATTERY_STOP_STATE)");
                              #endif
 336   4      
 337   4                      /*
 338   4                      if((bytBatteryStopCharge==_FALSE)&&(Check_ADAP_IN()==_TRUE)&&((GET_BATTERY_STATE()==_BATT_STATUS_C
             -APACITY_MAX)||(GET_BATTERY_STATE()==_BATT_STATUS_CAPACITY_MAX_STOP)))
 339   4                      {
 340   4                      bytBatteryStopCharge=_TRUE;
 341   4                      if(ReadEEP(EEP_BatteryStopCharge)==OFF)
 342   4                      WriteEEP(EEP_BatteryStopCharge,ON);
 343   4                        
 344   4                      #if(_DEBUG_MESSAGE_Battery_Charge_Debug==ON)
 345   4                        GraphicsPrint(RED,"(2bytBatteryStopCharge=1)");
 346   4                      #endif
 347   4                      SET_BATTERY_CHARGE_STATE(_BATT_STATUS_NONE);
 348   4                      }
 349   4                      */
 350   4                  }   
 351   3              }
 352   2                break;
 353   2          case  _BATT_STATUS_NORMAL_CHARGE:
 354   2            
 355   2            if(bytBatteryStopCharge==_TRUE)
 356   2              {
 357   3                  SET_PWM(_CHG_CURR,_CHARGESTOP); 
 358   3            #if (_DEBUG_MESSAGE_BatteryVoltage==ON)
                        GraphicsPrint(MAGENTA,"(Normal Current Charge__bytBatteryStopCharge=1)"); 
                    #endif
 361   3              }
 362   2            else
C51 COMPILER V9.60.0.0   SYSPOWER                                                          08/24/2021 10:37:20 PAGE 7   

 363   2          
 364   2              {
 365   3                SET_PWM(_CHG_CURR,_CHARGE700mA); 
 366   3            #if (_DEBUG_MESSAGE_BatteryVoltage==ON)
                        GraphicsPrint(MAGENTA,"(Normal Current Charge)"); 
                    #endif
 369   3              }
 370   2      
 371   2            SET_BATTERY_CHARGE_STATE(_BATT_STATUS_NORMAL_CHARGE); 
 372   2            
 373   2            if((GET_DVR_SystemReadyNotic()==_FALSE)&&(PowerFlag==ON))
 374   2              MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_BLINK);
 375   2            else if(GET_POWER_STATUS()==_POWER_STATUS_SAVING)
 376   2              { 
 377   3                if((GET_AC_PLUG()==_TRUE)&&(bytBatteryStopCharge==_FALSE))
 378   3                MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_2S_BLINK_RED_ON);//Update LED Status   
 379   3                else
 380   3                MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_2S_BLINK);//Update LED Status    
 381   3                
 382   3              }
 383   2            else
 384   2              {
 385   3                if((PowerFlag==OFF)&&(STAT1_Flag==OFF)&&(STAT2_Flag==ON)&&(bytBatteryStopCharge==_FALSE))
 386   3                MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_OFF_RED_ON);//Update LED Status          
 387   3                else if((STAT1_Flag==OFF)&&(STAT2_Flag==ON)&&(bytBatteryStopCharge==_FALSE))
 388   3                MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_RED_ON);//Update LED Status
 389   3                else
 390   3                  {
 391   4                MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_ON_RED_OFF);//Update LED Status
 392   4      
 393   4                MCUTimerCancelTimerEvent(_SYSTEM_TIMER_EVENT_CHECK_BATTERY_STOP_STATE);
 394   4                MCUTimerActiveTimerEvent(SEC(5), _SYSTEM_TIMER_EVENT_CHECK_BATTERY_STOP_STATE);
 395   4      
 396   4                        #if(_DEBUG_MESSAGE_Battery_Charge_Debug==ON)
                                GraphicsPrint(GREEN,"(3BATTERY_STOP_STATE)");
                                #endif
 399   4                        /*
 400   4                        if((bytBatteryStopCharge==_FALSE)&&(Check_ADAP_IN()==_TRUE)&&((GET_BATTERY_STATE()==_BATT_STATUS_
             -CAPACITY_MAX)||(GET_BATTERY_STATE()==_BATT_STATUS_CAPACITY_MAX_STOP)))
 401   4                        {
 402   4                        bytBatteryStopCharge=_TRUE;
 403   4                        if(ReadEEP(EEP_BatteryStopCharge)==OFF)
 404   4                        WriteEEP(EEP_BatteryStopCharge,ON);
 405   4                        
 406   4                          #if(_DEBUG_MESSAGE_Battery_Charge_Debug==ON)
 407   4                            GraphicsPrint(RED,"(3bytBatteryStopCharge=1)");
 408   4                          #endif
 409   4                          SET_BATTERY_CHARGE_STATE(_BATT_STATUS_NONE);
 410   4                        } 
 411   4                        */
 412   4                  }
 413   3              }
 414   2                break;          
 415   2          case  _BATT_STATUS_NO_BATT:
 416   2                SET_PWM(_CHG_CURR,_CHARGE060mA);
 417   2            #if (_DEBUG_MESSAGE_BatteryVoltage==ON)
                        GraphicsPrint(MAGENTA,"(1_NO BATT)");       
                    #endif
 420   2                SET_BATTERY_CHARGE_STATE(_BATT_STATUS_NO_BATT);
 421   2            
 422   2            if((GET_DVR_SystemReadyNotic()==_FALSE)&&(PowerFlag==ON))
 423   2              MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_BLINK);
C51 COMPILER V9.60.0.0   SYSPOWER                                                          08/24/2021 10:37:20 PAGE 8   

 424   2            else  if(GET_POWER_STATUS()==_POWER_STATUS_NORMAL)
 425   2               MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_ON_RED_OFF);//Update LED Status
 426   2            else if(GET_POWER_STATUS()==_POWER_STATUS_SAVING)  
 427   2              MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_2S_BLINK);//Update LED Status
 428   2            else  
 429   2              {
 430   3              MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_RED_OFF);//Update LED Status
 431   3              }
 432   2              break;
 433   2                       case _BATT_STATUS_DVR_OFF:         
 434   2              #if (_DEBUG_MESSAGE_PowerTimerEvent==ON)
                        GraphicsPrint(MAGENTA,"(DVR_POWER_OFF)"); 
                      #endif
 437   2      
 438   2                if(GET_DVR_RebootAndPower()==_TRUE)
 439   2                UserInterfacePowerSwitch(_POWER_ACTION_NORMAL_TO_OFF);
 440   2                else
 441   2                CLR_PCON5V();  
 442   2      
 443   2              MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_RED_BLINK);//Update LED Status
 444   2                   break;
 445   2      
 446   2                       case _BATT_STATUS_DVR_ON:
 447   2                  #if (_DEBUG_MESSAGE_PowerTimerEvent==ON)
                           GraphicsPrint(MAGENTA,"(DVR_POWER_ON)"); 
                          #endif
 450   2      
 451   2                    if(GET_DVR_RebootAndPower()==_TRUE)
 452   2                    {
 453   3                    UserInterfacePowerSwitch(_POWER_ACTION_OFF_TO_NORMAL);
 454   3                    CLR_DVR_RebootAndPower();
 455   3                    }
 456   2                    else
 457   2                     SET_PCON5V();  
 458   2      
 459   2                  if(GET_DVR_SystemReadyNotic()==_TRUE)
 460   2                  MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_ON_RED_OFF);//Update LED Status
 461   2                  else
 462   2                  MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_RED_BLINK);//Update LED Status
 463   2      
 464   2                  break;    
 465   2        }
 466   1      
 467   1      }
 468          #else
              void UserInterfaceBatteryChargeMode(EnumBatteryStatus enumSwitch)
              {
              
                MCUTimerCancelTimerEvent(_SYSTEM_TIMER_EVENT_GRN_BLINK);
                MCUTimerCancelTimerEvent(_SYSTEM_TIMER_EVENT_GRN_2S_BLINK);
                MCUTimerCancelTimerEvent( _SYSTEM_TIMER_EVENT_RED_BLINK);
                MCUTimerCancelTimerEvent( _SYSTEM_TIMER_EVENT_GRN_RED_BLINK);
                MCUTimerCancelTimerEvent( _SYSTEM_TIMER_EVENT_GRN_ON_RED_BLINK);
                MCUTimerCancelTimerEvent( _SYSTEM_TIMER_EVENT_GRN_2S_BLINK_RED_ON);
              
                switch(enumSwitch)
                {
                case  _BATT_STATUS_STOP_CHARGE: 
                      SET_PWM(_CHG_CURR,_CHARGE000mA);  
                    #if (_DEBUG_MESSAGE_BatteryVoltage==ON)
                        GraphicsPrint(MAGENTA,"(1_Stop Charge)");   
                    #endif
C51 COMPILER V9.60.0.0   SYSPOWER                                                          08/24/2021 10:37:20 PAGE 9   

              
                    SET_BATTERY_CHARGE_STATE(_BATT_STATUS_STOP_CHARGE);
              
                  if((GET_DVR_SystemReadyNotic()==_FALSE)&&(PowerFlag==ON))
                    MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_BLINK);
                  else if(GET_POWER_STATUS()==_POWER_STATUS_SAVING)
                    {
                      if(GET_AC_PLUG()==_TRUE)
                      MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_2S_BLINK);//Update LED Status    
                      else
                        {
                          if(PowerFlag==OFF)
                          MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_RED_OFF);//Update LED Status               
                          else if(GET_BATTERY_STATE()==_BATT_STATUS_CAPACITY_LEVEL0 )
                          MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_RED_BLINK);//Update LED Status   
                          else
                          MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_2S_BLINK);//Update LED Status    
                        }
                    }
                  else   if(GET_POWER_STATUS()==_POWER_STATUS_NORMAL)
                    {
                      if(GET_BATTERY_STATE()==_BATT_STATUS_CAPACITY_LEVEL0)
                      MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_ON_RED_BLINK);//Update LED Status      
                       else
                       MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_ON_RED_OFF);//Update LED Status
                    }
                  else           
                    MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_RED_OFF);//Update LED Status
              
                        break;    
                  case  _BATT_STATUS_LOW_CHARGE:
                        SET_PWM(_CHG_CURR,_CHARGE300mA); 
                    #if (_DEBUG_MESSAGE_BatteryVoltage==ON)
                        GraphicsPrint(MAGENTA,"(Low Current Charge)");  
                    #endif
                        SET_BATTERY_CHARGE_STATE(_BATT_STATUS_LOW_CHARGE);  
                    
                    if((GET_DVR_SystemReadyNotic()==_FALSE)&&(PowerFlag==ON))
                      MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_BLINK);
                    else if(GET_POWER_STATUS()==_POWER_STATUS_SAVING)
                      { if(GET_AC_PLUG()==_TRUE)
                        MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_2S_BLINK_RED_ON);//Update LED Status   
                        else
                        MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_BLINK);//Update LED Status   
                        
                      }
                    else
                      {
                        if((PowerFlag==OFF)&&(STAT1_Flag==OFF)&&(STAT2_Flag==ON))
                        MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_OFF_RED_ON);//Update LED Status          
                        else if((STAT1_Flag==OFF)&&(STAT2_Flag==ON))
                        MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_RED_ON);//Update LED Status
                        else
                        MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_ON_RED_OFF);//Update LED Status
                          
                      }
                        break;
                  case  _BATT_STATUS_HIGH_CHARGE:
                        SET_PWM(_CHG_CURR,_CHARGE1000mA); 
                    #if (_DEBUG_MESSAGE_BatteryVoltage==ON)
                        GraphicsPrint(MAGENTA,"(High Current Charge)"); 
                    #endif
C51 COMPILER V9.60.0.0   SYSPOWER                                                          08/24/2021 10:37:20 PAGE 10  

                  
                    SET_BATTERY_CHARGE_STATE(_BATT_STATUS_HIGH_CHARGE);
              
                    
                    if((GET_DVR_SystemReadyNotic()==_FALSE)&&(PowerFlag==ON))
                      MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_BLINK);
                    else if(GET_POWER_STATUS()==_POWER_STATUS_SAVING)
                      { if(GET_AC_PLUG()==_TRUE)
                        MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_RED_BLINK);//Update LED Status   
                        else
                        MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_BLINK);//Update LED Status     
                      }
                    else
                      {
                        if((STAT1_Flag==OFF)&&(STAT2_Flag==ON))
                        MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_OFF_RED_ON);//Update LED Status
                        else
                        MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_RED_OFF);//Update LED Status
                              
                      }
                        break;
                  case  _BATT_STATUS_NORMAL_CHARGE:
                        SET_PWM(_CHG_CURR,_CHARGE700mA); 
                    #if (_DEBUG_MESSAGE_BatteryVoltage==ON)
                        GraphicsPrint(MAGENTA,"(2Normal Current Charge)");  
                    #endif
                        SET_BATTERY_CHARGE_STATE(_BATT_STATUS_NORMAL_CHARGE); 
                    
                    if((GET_DVR_SystemReadyNotic()==_FALSE)&&(PowerFlag==ON))
                      MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_BLINK);
                    else if(GET_POWER_STATUS()==_POWER_STATUS_SAVING)
                      { 
                        if(GET_AC_PLUG()==_TRUE)
                        MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_2S_BLINK_RED_ON);//Update LED Status   
                        else
                        MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_BLINK);//Update LED Status   
                        
                      }
                    else
                      {
                        if((PowerFlag==OFF)&&(STAT1_Flag==OFF)&&(STAT2_Flag==ON))
                        MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_OFF_RED_ON);//Update LED Status          
                        else if((STAT1_Flag==OFF)&&(STAT2_Flag==ON))
                        MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_RED_ON);//Update LED Status
                        else
                        MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_ON_RED_OFF);//Update LED Status
                          
                      }
                        break;          
                  case  _BATT_STATUS_NO_BATT:
                        SET_PWM(_CHG_CURR,_CHARGE060mA);
                    #if (_DEBUG_MESSAGE_BatteryVoltage==ON)
                        GraphicsPrint(MAGENTA,"(1_NO BATT)");       
                    #endif
                        SET_BATTERY_CHARGE_STATE(_BATT_STATUS_NO_BATT);
                    
                    if((GET_DVR_SystemReadyNotic()==_FALSE)&&(PowerFlag==ON))
                      MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_BLINK);
                    else  if(GET_POWER_STATUS()==_POWER_STATUS_NORMAL)
                       MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_ON_RED_OFF);//Update LED Status
                    else if(GET_POWER_STATUS()==_POWER_STATUS_SAVING)  
                      MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_2S_BLINK);//Update LED Status
C51 COMPILER V9.60.0.0   SYSPOWER                                                          08/24/2021 10:37:20 PAGE 11  

                    else  
                      {
                      MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_RED_OFF);//Update LED Status
                      }
                    break;
                               case _BATT_STATUS_DVR_OFF:         
                      #if (_DEBUG_MESSAGE_PowerTimerEvent==ON)
                        GraphicsPrint(MAGENTA,"(DVR_POWER_OFF)"); 
                      #endif
              
                        if(GET_DVR_RebootAndPower()==_TRUE)
                        UserInterfacePowerSwitch(_POWER_ACTION_NORMAL_TO_OFF);
                        else
                        CLR_PCON5V();  
              
                      MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_RED_BLINK);//Update LED Status
                           break;
              
                               case _BATT_STATUS_DVR_ON:
                          #if (_DEBUG_MESSAGE_PowerTimerEvent==ON)
                           GraphicsPrint(MAGENTA,"(DVR_POWER_ON)"); 
                          #endif
              
                            if(GET_DVR_RebootAndPower()==_TRUE)
                            {
                            UserInterfacePowerSwitch(_POWER_ACTION_OFF_TO_NORMAL);
                            CLR_DVR_RebootAndPower();
                            }
                            else
                             SET_PCON5V();  
              
                          if(GET_DVR_SystemReadyNotic()==_TRUE)
                          MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_ON_RED_OFF);//Update LED Status
                          else
                          MCUTimerActiveTimerEvent(SEC(0.1), _SYSTEM_TIMER_EVENT_GRN_RED_BLINK);//Update LED Status
              
                          break;    
                }
              
              }
              
              #endif
 652          void UserInterfacePowerSwitch(EnumPowerAction enumSwitch)
 653          {
 654   1        Printf("\r\n(PowerSwitch=%02x)",(WORD)enumSwitch);  
 655   1      
 656   1        
 657   1          switch(enumSwitch)
 658   1          {
 659   2              case _POWER_ACTION_AC_ON_TO_NORMAL:
 660   2        case _POWER_ACTION_PS_TO_NORMAL:
 661   2        case _POWER_ACTION_OFF_TO_NORMAL:
 662   2      #if 1     
 663   2        
 664   2            SET_PCON5V();   
 665   2            SET_PWCTRL();
 666   2            SET_AC_MODE();
 667   2            SET_BAT_SYS();
 668   2            SET_PCON_CAM();
 669   2            SET_PCON3V3_TW();
 670   2            MCUTimerDelayXms(20);//delay 20ms Power-On Sequence of Panel    
 671   2            CLR_TW8836_RST();
C51 COMPILER V9.60.0.0   SYSPOWER                                                          08/24/2021 10:37:20 PAGE 12  

 672   2            
 673   2        MCUTimerActiveTimerEvent(SEC(0.5), _SYSTEM_TIMER_EVENT_JUDGE_FIRST_GET_BATT_BTH_STATE);
 674   2        MCUTimerActiveTimerEvent(SEC(/*0.5*/1), _USER_TIMER_EVENT_PANEL_BACKLIGHT_ON);  
 675   2      
 676   2      #else
                    SET_PCON3V3_P();
                    SET_Panel_EN();
                    SET_PCON5V_P();
                    SET_PCON5V();   
                    SET_PWCTRL();
                    SET_BL_PWM();
                    SET_AC_MODE();
                    SET_BAT_SYS();
                    SET_PCON_CAM();
                    SET_PCON3V3_TW();
                    MCUTimerDelayXms(64);//delay 64ms Power-On Sequence and Reset
                    CLR_TW8836_RST();  
              #endif
 690   2                  break;
 691   2          case  _POWER_ACTION_PANEL_POWER_ON:
 692   2            SET_PCON3V3_P();
 693   2            SET_Panel_EN();
 694   2            MCUTimerDelayXms(64);//delay 64ms Power-On Sequence and Reset
 695   2            SET_PCON5V_P();
 696   2            SET_BL_PWM();
 697   2      
 698   2            if(GET_DVR_EntrySleepMode()==_TRUE)
 699   2            {
 700   3            CLR_DVR_EntrySleepMode();
 701   3            MCU_SendCmdToDVR(MCU_PROTOCOL_CMD_SLEEP_WAKE_UP);
 702   3            }
 703   2      
 704   2            P3M1=0x00|0x30;//p3.4 and P3.5 set push pull mode ryan@20210223
 705   2            break;
 706   2      
 707   2              case _POWER_ACTION_AC_ON_TO_OFF:
 708   2        case _POWER_ACTION_NORMAL_TO_OFF:
 709   2        case _POWER_ACTION_PS_TO_OFF:
 710   2      
 711   2          SET_TW8836_RST(); 
 712   2          CLR_PCON3V3_P();
 713   2          CLR_PCON5V_P();
 714   2          CLR_Panel_EN();
 715   2          CLR_PCON5V();
 716   2          CLR_Panel_EN();
 717   2          CLR_PWCTRL();
 718   2          CLR_AC_MODE();
 719   2          CLR_BAT_SYS();
 720   2          CLR_PCON_CAM();
 721   2          //#if (_DEBUG_MESSAGE_Monitor==ON)
 722   2          //#else
 723   2          //CLR_PCON3V3_TW(); ///關閉debug message UART1 有問題
 724   2          //#endif
 725   2          CLR_BL_PWM();
 726   2      
 727   2          #if 0// (_DEBUG_MESSAGE_Monitor==ON)
                  #else
 729   2          CLR_PCON3V3_TW(); ///關閉debug message UART1 有問題
 730   2          #endif
 731   2      
 732   2          SET_DVR_PowerOFFDelay();
 733   2          MCUTimerActiveTimerEvent( SEC(3),_SYSTEM_TIMER_EVENT_POWER_OFF_ON_DELAY);
C51 COMPILER V9.60.0.0   SYSPOWER                                                          08/24/2021 10:37:20 PAGE 13  

 734   2                  break;
 735   2      
 736   2              case _POWER_ACTION_NORMAL_TO_PS:
 737   2      
 738   2            //CLR_PCON3V3_P();
 739   2            //CLR_PCON5V_P();
 740   2            CLR_Panel_EN();
 741   2            CLR_PCON5V_P();
 742   2            CLR_PWCTRL();
 743   2            CLR_AC_MODE();
 744   2            //CLR_BAT_SYS();
 745   2            CLR_PCON_CAM();
 746   2            CLR_BL_PWM();
 747   2            //CLR_PCON5V();
 748   2            //SET_TW8836_RST(); 
 749   2            //CLR_PCON3V3_TW();
 750   2            
 751   2            P3M1=0x00;//p3.4 and P3.5 set output ryan@20210226
 752   2                  break;
 753   2      
 754   2              default:
 755   2      
 756   2                  break;
 757   2          }
 758   1      
 759   1          
 760   1      SET_BATTERY_CHARGE_STATE(_BATT_STATUS_NONE);//reset battery state.
 761   1      
 762   1      }
 763          
 764          //--------------------------------------------------
 765          // Description  : Deal With Power Manage According To Input Pamater
 766          // Input Value  : ucSwitch    --> Power action description.
 767          // Output Value : None
 768          //--------------------------------------------------
 769          void SysPowerSwitch(EnumPowerAction enumSwitch)
 770          {
 771   1      
 772   1      
 773   1          switch(enumSwitch)
 774   1          {
 775   2              case _POWER_ACTION_NORMAL_TO_PS:
 776   2            UserInterfacePowerSwitch(enumSwitch); 
 777   2                  break;
 778   2      
 779   2              case _POWER_ACTION_NORMAL_TO_OFF:
 780   2              case _POWER_ACTION_AC_ON_TO_OFF:
 781   2        case _POWER_ACTION_DVR_POWER_OFF: 
 782   2            case _POWER_ACTION_PS_TO_OFF:
 783   2          UserInterfacePowerSwitch(enumSwitch); 
 784   2        break;
 785   2                  
 786   2      //       case _POWER_ACTION_PS_TO_OFF:
 787   2      //            break;
 788   2      
 789   2              case _POWER_ACTION_AC_ON_TO_NORMAL:
 790   2              case _POWER_ACTION_OFF_TO_NORMAL:
 791   2              case _POWER_ACTION_PS_TO_NORMAL:    
 792   2               case _POWER_ACTION_PS_TO_BATT: 
 793   2        case _POWER_ACTION_DVR_POWER_ON:
 794   2        case  _POWER_ACTION_PANEL_POWER_ON:
 795   2          // User Power Process
C51 COMPILER V9.60.0.0   SYSPOWER                                                          08/24/2021 10:37:20 PAGE 14  

 796   2                      UserInterfacePowerSwitch(enumSwitch);        
 797   2                break;
 798   2            
 799   2              default:
 800   2                  break;
 801   2          }
 802   1        
 803   1      }
 804          
 805          
 806          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1217    ----
   CONSTANT SIZE    =     45    ----
   XDATA SIZE       =   ----       3
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =      2    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
